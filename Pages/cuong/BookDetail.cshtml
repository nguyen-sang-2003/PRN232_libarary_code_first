@page "/book/{id:int}"
@using LibararyWebApplication.DTO
@model LibararyWebApplication.Pages.cuong.BookDetailModel
@{
}
<link rel="stylesheet" href="/bootstrap/bootstrap.min.css" />
<link rel="stylesheet" href="/app.css" />
<link rel="stylesheet" href="/LibararyWebApplication.styles.css" />
<link rel="icon" type="image/png" href="favicon.png" />

<h3>Book Details</h3>
@{
	BookDto book = Model.book;

	if (book == null)
	{
		<div class="d-flex justify-content-center my-5">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Loading...</span>
			</div>
		</div>
	}
	else
	{
		<div class="container my-5">
			<div class="card shadow border-0">
				<div class="row g-0 align-items-center">
					<div class="col-md-4 text-center p-4">
						<img src="@book.ImageBase64"
							 class="img-fluid rounded shadow-sm"
							 alt="@book.Title"
							 style="max-height: 300px; object-fit: contain;" />
					</div>
					<div class="col-md-8">
						<div class="card-body px-4">
							<h3 class="card-title fw-bold text-danger">@book.Title</h3>
							<p class="card-text fs-5 mb-1">
								<strong>Author:</strong> @book.AuthorName
							</p>
							<p class="card-text fs-5 mb-1">
								<strong>Published:</strong> @book.PublishedDate.ToShortDateString()
							</p>
							<p class="card-text fs-5 mb-1">
								<strong>Total Copies:</strong> @book.TotalCopies
							</p>
							<p class="card-text fs-5 mb-3">
								<strong>Available Copies:</strong> @book.AvailableCopies
							</p>
							<button id="borrowBtn" data-bookid="@book.Id" class="btn btn-outline-success btn-lg mt-2">
								&larr; Borrowing
							</button>
                            <!--
							<a href="/borrowing-history" class="btn btn-outline-info btn-lg mt-2">
								üìö L·ªãch s·ª≠ m∆∞·ª£n s√°ch
							</a>
                            -->
							<button class="btn btn-outline-primary btn-lg mt-2" onclick="goBack()">‚Üê Back to Books</button>

						</div>
					</div>
				</div>
			</div>
		</div>
	}

}
<script src="/TemplateLibraryHomePage/js/jquery.min.js"></script>
<script>
    // Function ƒë·ªÉ l·∫•y token t·ª´ localStorage ho·∫∑c cookie
    function getCurrentToken() {
        let token = localStorage.getItem("token");
        if (!token) {
            // L·∫•y t·ª´ cookie n·∫øu kh√¥ng c√≥ trong localStorage
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'token') {
                    token = value;
                    break;
                }
            }
        }
        return token;
    }

    // X·ª≠ l√Ω s·ª± ki·ªán click n√∫t m∆∞·ª£n s√°ch
    $('#borrowBtn').click(function() {
        var bookId = $(this).data('bookid');

        // L·∫•y token hi·ªán t·∫°i
        const token = getCurrentToken();

        if (!token) {
            alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ m∆∞·ª£n s√°ch!');
            window.location.href = '/login?return_url=' + encodeURIComponent(window.location.pathname);
            return;
        }

        // Debug: Log token info
        console.log('Token found:', token.substring(0, 20) + '...');
        console.log('Book ID:', bookId);

        // Disable n√∫t ƒë·ªÉ tr√°nh click nhi·ªÅu l·∫ßn
        $(this).prop('disabled', true).text('ƒêang x·ª≠ l√Ω...');

        $.ajax({
            url: '/api/borrowing/rentals/request?bookId=' + bookId,
            type: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            success: function(response) {
                console.log('Borrow success:', response);
                alert('M∆∞·ª£n s√°ch th√†nh c√¥ng!\nUser: ' + response.username + '\nBook ID: ' + response.bookId);
                window.location.href = '/'; // Chuy·ªÉn v·ªÅ trang ch·ªß
            },
            error: function(xhr) {
                // Re-enable n√∫t
                $('#borrowBtn').prop('disabled', false).text('‚Üê Borrowing');

                if (xhr.status === 401) {
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!');
                    window.location.href = '/login?return_url=' + encodeURIComponent(window.location.pathname);
                } else if (xhr.status === 400) {
                    alert('M∆∞·ª£n s√°ch th·∫•t b·∫°i: ' + (xhr.responseText || 'Kh√¥ng c√≤n b·∫£n sao n√†o kh·∫£ d·ª•ng'));
                } else {
                    alert('M∆∞·ª£n s√°ch th·∫•t b·∫°i: ' + (xhr.responseText || 'C√≥ l·ªói x·∫£y ra'));
                }
            }
        });
    });

    // Function ƒë·ªÉ quay l·∫°i trang s√°ch
    function goBack() {
        window.location.href = '/';
    }
</script>
